#!/bin/bash
set -eo pipefail

# MCP Code Indexer - Post-Rewrite Hook
# 
# This hook processes rewritten commits after git rebase, amend, or other
# commit-rewriting operations. It reads the list of old/new commit pairs
# from stdin and efficiently processes them using commit ranges.
#
# Installation:
#   cp examples/post-rewrite-hook .git/hooks/post-rewrite
#   chmod +x .git/hooks/post-rewrite
#
# Requirements:
#   - mcp-code-indexer installed and in PATH
#   - OPENROUTER_API_KEY environment variable set

cd "$(git rev-parse --show-toplevel)"

# Read the list of rewritten commits from stdin
first_hash=""
last_hash=""
count=0

echo "Post-rewrite hook: Processing rewritten commits..." >&2

while read -r old_sha new_sha; do
  # Skip invalid lines (e.g., comments)
  [[ "$old_sha" =~ ^# ]] && continue
  
  echo "  Rewritten: $old_sha -> $new_sha" >&2
  
  # Track first and last commits
  if [ $count -eq 0 ]; then
    first_hash="$new_sha"
  fi
  last_hash="$new_sha"
  ((count++))
done < "$1"

# Process the commit range if we have commits
if [ $count -gt 0 ]; then
  echo "Post-rewrite hook: Updating descriptions for $count commits..." >&2
  
  if [ $count -eq 1 ]; then
    # Single commit
    echo "  Processing single commit: $first_hash" >&2
    mcp-code-indexer --githook "$first_hash" >> ~/.mcp-code-index/githook.log 2>&1 &
  else
    # Commit range - use first commit's parent to last commit
    parent_hash=$(git rev-parse "${first_hash}~1" 2>/dev/null || echo "")
    if [ -n "$parent_hash" ]; then
      echo "  Processing commit range: $parent_hash..$last_hash" >&2
      mcp-code-indexer --githook "$parent_hash" "$last_hash" >> ~/.mcp-code-index/githook.log 2>&1 &
    else
      # If no parent (first commit), process the single commit
      echo "  Processing first commit: $first_hash" >&2
      mcp-code-indexer --githook "$first_hash" >> ~/.mcp-code-index/githook.log 2>&1 &
    fi
  fi
  disown  # Detach background process
  
  echo "Post-rewrite hook: Background analysis started. Check ~/.mcp-code-index/githook.log for progress." >&2
else
  echo "Post-rewrite hook: No commits to process." >&2
fi

exit 0
